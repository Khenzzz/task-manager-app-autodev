{% extends "base.html" %}

{% block title %}{{ project.name }} - Task Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <!-- Project Header -->
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">{{ project.name }}</h4>
                    {% if project.status %}
                    <span class="badge bg-{{ project.status == 'active' and 'success' or 
                                             project.status == 'completed' and 'primary' or 
                                             project.status == 'on_hold' and 'warning' or 'secondary' }} mt-1">
                        {{ project.status.replace('_', ' ').title() }}
                    </span>
                    {% endif %}
                </div>
                <div>
                    <a href="{{ url_for('projects.edit', project_id=project.id) }}" class="btn btn-sm btn-warning me-2">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <form method="POST" action="{{ url_for('projects.delete', project_id=project.id) }}" 
                          class="d-inline" onsubmit="return confirm('Are you sure you want to delete this project?')">
                        <button type="submit" class="btn btn-sm btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                {% if project.description %}
                <div class="mb-3">
                    <h6>Description</h6>
                    <p class="text-muted">{{ project.description }}</p>
                </div>
                {% endif %}
                
                <!-- Project Statistics -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="bg-primary text-white p-3 rounded text-center">
                            <h4 class="mb-0">{{ tasks|length }}</h4>
                            <small>Total Tasks</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="bg-success text-white p-3 rounded text-center">
                            <h4 class="mb-0">{{ tasks|selectattr('status', 'equalto', 'completed')|list|length }}</h4>
                            <small>Completed</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="bg-info text-white p-3 rounded text-center">
                            <h4 class="mb-0">{{ tasks|selectattr('status', 'equalto', 'in_progress')|list|length }}</h4>
                            <small>In Progress</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="bg-warning text-white p-3 rounded text-center">
                            <h4 class="mb-0">{{ members|length }}</h4>
                            <small>Members</small>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                {% if tasks %}
                {% set completed_tasks = tasks|selectattr('status', 'equalto', 'completed')|list|length %}
                {% set completion_rate = (completed_tasks / tasks|length * 100) if tasks|length > 0 else 0 %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Project Progress</h6>
                        <small class="text-muted">{{ "%.0f"|format(completion_rate) }}% Complete</small>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ completion_rate }}%"
                             aria-valuenow="{{ completion_rate }}" 
                             aria-valuemin="0" aria-valuemax="100">
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="row">
                    <div class="col-md-6">
                        <strong>Created:</strong> {{ project.created_at[:10] if project.created_at }}
                    </div>
                    <div class="col-md-6">
                        <strong>Updated:</strong> {{ project.updated_at[:10] if project.updated_at }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Project Tasks -->
        <div class="card shadow mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-tasks"></i> Project Tasks 
                    <span class="badge bg-secondary">{{ tasks|length }}</span>
                </h5>
                <a href="{{ url_for('tasks.create') }}?project_id={{ project.id }}" class="btn btn-sm btn-success">
                    <i class="fas fa-plus"></i> Add Task
                </a>
            </div>
            <div class="card-body">
                {% if tasks %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Assigned To</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('tasks.detail', task_id=task.id) }}" 
                                       class="text-decoration-none fw-bold">
                                        {{ task.title }}
                                    </a>
                                    {% if task.description %}
                                    <br>
                                    <small class="text-muted">
                                        {{ task.description[:60] }}{% if task.description|length > 60 %}...{% endif %}
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ task.status == 'completed' and 'success' or 
                                                             task.status == 'in_progress' and 'info' or 
                                                             task.status == 'cancelled' and 'dark' or 'light' }}">
                                        {{ task.status.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{{ task.priority == 'critical' and 'danger' or 
                                                             task.priority == 'high' and 'warning' or 
                                                             task.priority == 'medium' and 'primary' or 'secondary' }}">
                                        {{ task.priority.title() }}
                                    </span>
                                </td>
                                <td>
                                    {% if task.assigned_to %}
                                        User #{{ task.assigned_to }}
                                    {% else %}
                                        <span class="text-muted">Unassigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if task.due_date %}
                                        <span class="{% if task.is_overdue %}text-danger fw-bold{% endif %}">
                                            {% if task.is_overdue %}
                                                <i class="fas fa-exclamation-triangle"></i>
                                            {% endif %}
                                            {{ task.due_date[:10] }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">No due date</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('tasks.detail', task_id=task.id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('tasks.edit', task_id=task.id) }}" 
                                           class="btn btn-sm btn-outline-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% if task.status != 'completed' %}
                                        <form method="POST" action="{{ url_for('tasks.update_status', task_id=task.id) }}" 
                                              class="d-inline">
                                            <input type="hidden" name="status" value="completed">
                                            <button type="submit" class="btn btn-sm btn-outline-success" 
                                                    title="Mark as completed">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No tasks in this project yet</h6>
                    <p class="text-muted">Create the first task to get started!</p>
                    <a href="{{ url_for('tasks.create') }}?project_id={{ project.id }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Create First Task
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card shadow">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-rocket"></i> Quick Actions
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('tasks.create') }}?project_id={{ project.id }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Task
                    </a>
                    <a href="{{ url_for('projects.edit', project_id=project.id) }}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> Edit Project
                    </a>
                    <a href="{{ url_for('tasks.list') }}?project_id={{ project.id }}" class="btn btn-outline-primary">
                        <i class="fas fa-list"></i> View All Tasks
                    </a>
                    <a href="{{ url_for('projects.list') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Projects
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Project Members -->
        <div class="card shadow mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-users"></i> Project Members 
                    <span class="badge bg-secondary">{{ members|length }}</span>
                </h6>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="card-body">
                {% if members %}
                <div class="list-group list-group-flush">
                    {% for member in members %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>User #{{ member.user_id }}</strong>
                            <br>
                            <span class="badge bg-{{ member.role == 'owner' and 'danger' or 
                                                     member.role == 'admin' and 'warning' or 
                                                     member.role == 'member' and 'primary' or 'secondary' }}">
                                {{ member.role.title() }}
                            </span>
                        </div>
                        {% if member.role != 'owner' %}
                        <form method="POST" action="{{ url_for('projects.remove_member', project_id=project.id, user_id=member.user_id) }}" 
                              class="d-inline" onsubmit="return confirm('Remove this member?')">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-times"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <p class="mb-0">No members yet</p>
                    <small>Add team members to collaborate</small>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Project Information -->
        <div class="card shadow mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> Project Information
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Project ID:</strong> {{ project.id }}
                </div>
                
                <div class="mb-2">
                    <strong>Owner:</strong> User #{{ project.owner_id }}
                </div>
                
                <div class="mb-2">
                    <strong>Tasks:</strong> {{ tasks|length }}
                </div>
                
                <div class="mb-2">
                    <strong>Members:</strong> {{ members|length }}
                </div>
                
                {% if tasks %}
                <div class="mb-2">
                    <strong>Completion:</strong> 
                    {{ "%.0f"|format((tasks|selectattr('status', 'equalto', 'completed')|list|length / tasks|length * 100) if tasks|length > 0 else 0) }}%
                </div>
                {% endif %}
                
                <div class="mb-2">
                    <strong>Created:</strong> {{ project.created_at[:10] if project.created_at }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMemberModalLabel">
                    <i class="fas fa-user-plus"></i> Add Project Member
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('projects.add_member', project_id=project.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="user_id" class="form-label">User ID</label>
                        <input type="number" class="form-control" id="user_id" name="user_id" 
                               placeholder="Enter user ID" required>
                        <div class="form-text">Enter the ID of the user you want to add to this project.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select class="form-select" id="role" name="role">
                            <option value="member" selected>Member</option>
                            <option value="admin">Admin</option>
                            <option value="viewer">Viewer</option>
                        </select>
                        <div class="form-text">
                            <small>
                                <strong>Member:</strong> Can create and edit tasks<br>
                                <strong>Admin:</strong> Can manage project and members<br>
                                <strong>Viewer:</strong> Can only view tasks and progress
                            </small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add Member
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh project data every 60 seconds
setInterval(function() {
    location.reload();
}, 60000);

// Task status update with confirmation
document.addEventListener('DOMContentLoaded', function() {
    const statusForms = document.querySelectorAll('form[action*="status"]');
    
    statusForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            if (!confirm('Mark this task as completed?')) {
                e.preventDefault();
            }
        });
    });
});

// Project statistics animations
document.addEventListener('DOMContentLoaded', function() {
    const statCards = document.querySelectorAll('.bg-primary, .bg-success, .bg-info, .bg-warning');
    
    statCards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'scale(0.8)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.3s ease';
            card.style.opacity = '1';
            card.style.transform = 'scale(1)';
        }, index * 100);
    });
});
</script>
{% endblock %}