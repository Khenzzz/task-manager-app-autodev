{% extends "base.html" %}

{% block title %}{{ action }} Task - Task Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-{{ 'edit' if action == 'Edit' else 'plus' }}"></i> 
                    {{ action }} Task
                </h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <!-- Task Title -->
                        <div class="col-md-12 mb-3">
                            <label for="title" class="form-label">Task Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" name="title" 
                                   value="{{ task.title if task else '' }}" 
                                   placeholder="Enter task title..." required>
                        </div>
                        
                        <!-- Task Description -->
                        <div class="col-md-12 mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="4" placeholder="Enter task description...">{{ task.description if task else '' }}</textarea>
                        </div>
                        
                        <!-- Project Selection -->
                        <div class="col-md-6 mb-3">
                            <label for="project_id" class="form-label">Project <span class="text-danger">*</span></label>
                            <select class="form-select" id="project_id" name="project_id" required 
                                    {{ 'disabled' if action == 'Edit' else '' }}>
                                <option value="">Select a project</option>
                                {% for project in projects %}
                                <option value="{{ project.id }}" 
                                        {{ 'selected' if task and task.project_id == project.id }}>
                                    {{ project.name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if action == 'Edit' and task %}
                            <input type="hidden" name="project_id" value="{{ task.project_id }}">
                            {% endif %}
                        </div>
                        
                        <!-- Priority -->
                        <div class="col-md-6 mb-3">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="low" {{ 'selected' if task and task.priority == 'low' }}>
                                    Low
                                </option>
                                <option value="medium" {{ 'selected' if task and task.priority == 'medium' else 'selected' if not task }}>
                                    Medium
                                </option>
                                <option value="high" {{ 'selected' if task and task.priority == 'high' }}>
                                    High
                                </option>
                                <option value="critical" {{ 'selected' if task and task.priority == 'critical' }}>
                                    Critical
                                </option>
                            </select>
                        </div>
                        
                        <!-- Assigned To -->
                        <div class="col-md-6 mb-3">
                            <label for="assigned_to" class="form-label">Assign To</label>
                            <select class="form-select" id="assigned_to" name="assigned_to">
                                <option value="">Unassigned</option>
                                <option value="none">Remove Assignment</option>
                                <!-- Note: In a real app, you'd populate this with project members -->
                                {% if task and task.assigned_to %}
                                <option value="{{ task.assigned_to }}" selected>User #{{ task.assigned_to }}</option>
                                {% endif %}
                            </select>
                            <div class="form-text">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Only project members can be assigned to tasks
                                </small>
                            </div>
                        </div>
                        
                        <!-- Due Date -->
                        <div class="col-md-6 mb-3">
                            <label for="due_date" class="form-label">Due Date</label>
                            <input type="date" class="form-control" id="due_date" name="due_date" 
                                   value="{{ task.due_date[:10] if task and task.due_date else '' }}"
                                   min="{{ today }}">
                            <div class="form-text">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Leave empty for no due date
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <a href="{{ url_for('tasks.detail', task_id=task.id) if task else url_for('tasks.list') }}" 
                           class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Cancel
                        </a>
                        
                        <div>
                            {% if task and action == 'Edit' %}
                            <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            {% endif %}
                            
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> {{ action }} Task
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Task Preview (for editing) -->
        {% if task and action == 'Edit' %}
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-eye"></i> Current Task Details
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Status:</strong>
                        <span class="badge bg-{{ task.status == 'completed' and 'success' or 
                                                 task.status == 'in_progress' and 'info' or 
                                                 task.status == 'cancelled' and 'dark' or 'light' }} ms-2">
                            {{ task.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                    <div class="col-md-6">
                        <strong>Created:</strong> {{ task.created_at[:10] if task.created_at }}
                    </div>
                </div>
                
                {% if task.comments %}
                <div class="mt-3">
                    <strong>Comments:</strong> {{ task.comments|length }} comment{{ 's' if task.comments|length != 1 }}
                </div>
                {% endif %}
                
                <div class="mt-3">
                    <a href="{{ url_for('tasks.detail', task_id=task.id) }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> View Full Details
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Confirmation Modal -->
{% if task and action == 'Edit' %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Delete Task
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this task?</p>
                <div class="alert alert-warning">
                    <strong>{{ task.title }}</strong>
                    <br>
                    <small class="text-muted">This action cannot be undone.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('tasks.delete', task_id=task.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete Task
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set minimum date to today
    const dueDateInput = document.getElementById('due_date');
    if (dueDateInput) {
        const today = new Date().toISOString().split('T')[0];
        dueDateInput.setAttribute('min', today);
    }
    
    // Auto-resize description textarea
    const descriptionTextarea = document.getElementById('description');
    if (descriptionTextarea) {
        descriptionTextarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // Project selection change handler
    const projectSelect = document.getElementById('project_id');
    if (projectSelect) {
        projectSelect.addEventListener('change', function() {
            // In a real app, you'd load project members here for assignment
            console.log('Project changed:', this.value);
        });
    }
    
    // Form validation
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const title = document.getElementById('title').value.trim();
            const projectId = document.getElementById('project_id').value;
            
            if (!title) {
                e.preventDefault();
                alert('Task title is required.');
                document.getElementById('title').focus();
                return;
            }
            
            if (!projectId) {
                e.preventDefault();
                alert('Please select a project.');
                document.getElementById('project_id').focus();
                return;
            }
        });
    }
});
</script>
{% endblock %}